# BotManager - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Telegram –±–æ—Ç–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## –û–ø–∏—Å–∞–Ω–∏–µ

BotManager - —ç—Ç–æ —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ Telegram –±–æ—Ç–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **MongoDB Change Streams** - –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `customers`
- **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** —Ç–æ–∫–µ–Ω–æ–≤ –±–æ—Ç–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ –ë–î
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤ –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

### ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è** –≤—Å–µ—Ö –±–æ—Ç–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
- **–°—Ç–∞—Ç—É—Å—ã –±–æ—Ç–æ–≤**: `active`, `inactive`, `error`
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è** –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞

### üì° Event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **–°–æ–±—ã—Ç–∏—è** –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –±–æ—Ç–æ–≤
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å —ç–º–æ–¥–∑–∏
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```typescript
BotManager
‚îú‚îÄ‚îÄ bots: Map<customerId, BotInstance>    // –ö–µ—à –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤
‚îú‚îÄ‚îÄ changeStream: MongoDB Change Stream    // –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îî‚îÄ‚îÄ EventEmitter                          // –°–æ–±—ã—Ç–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```

### BotInstance
```typescript
interface BotInstance {
    bot: Telegraf;              // –≠–∫–∑–µ–º–ø–ª—è—Ä Telegram –±–æ—Ç–∞
    customerId: string;         // ID –∫–ª–∏–µ–Ω—Ç–∞
    username: string;           // –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞
    token: string;              // –¢–æ–∫–µ–Ω –±–æ—Ç–∞
    status: 'active' | 'inactive' | 'error';
    lastUpdated: Date;          // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
}
```

## –°–æ–±—ã—Ç–∏—è

```typescript
// –ë–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω
botManager.on('bot:added', (data) => {
    console.log(`ü§ñ Bot added: ${data.username} (@${data.botUsername})`);
});

// –ë–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω
botManager.on('bot:updated', (data) => {
    console.log(`üîÑ Bot updated: ${data.username} (@${data.botUsername})`);
});

// –ë–æ—Ç —É–¥–∞–ª–µ–Ω
botManager.on('bot:removed', (data) => {
    console.log(`üóëÔ∏è Bot removed: ${data.username}`);
});

// –û—à–∏–±–∫–∞ –±–æ—Ç–∞
botManager.on('bot:error', (data) => {
    console.log(`‚ùå Bot error for ${data.username}:`, data.error);
});

// –û—à–∏–±–∫–∞ Change Stream
botManager.on('stream:error', (data) => {
    console.error('‚ùå Change stream error:', data.error);
});
```

## API –º–µ—Ç–æ–¥—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
```typescript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞
await botManager.initialize();

// –ü–æ–ª—É—á–∏—Ç—å –±–æ—Ç–∞ –ø–æ customerId
const bot = botManager.getBot(customerId);

// –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ
const botInfo = botManager.getBotInfo(customerId);

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
const result = await botManager.sendMessage(customerId, chatId, message);

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞
const status = await botManager.checkBotStatus(customerId);

// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
const stats = botManager.getStats();

// –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ—Ö –±–æ—Ç–æ–≤
await botManager.reload();

// –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å  
await botManager.stop();
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```typescript
const stats = botManager.getStats();
/*
{
    total: 5,           // –í—Å–µ–≥–æ –±–æ—Ç–æ–≤
    active: 3,          // –ê–∫—Ç–∏–≤–Ω—ã—Ö
    inactive: 0,        // –ù–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö  
    error: 2,           // –° –æ—à–∏–±–∫–∞–º–∏
    isWatching: true    // Change Stream –∞–∫—Ç–∏–≤–µ–Ω
}
*/
```

## REST API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –î–ª—è –∞–¥–º–∏–Ω–∞
```http
GET /api/messages/bot-manager-stats
Authorization: Bearer <admin_jwt_token>
```

–û—Ç–≤–µ—Ç:
```json
{
    "message": "Bot manager statistics", 
    "stats": {
        "total": 5,
        "active": 3,
        "inactive": 0, 
        "error": 2,
        "isWatching": true
    },
    "bots": [
        {
            "customerId": "...",
            "username": "client1", 
            "status": "active",
            "lastUpdated": "2024-01-15T10:30:00.000Z"
        }
    ],
    "timestamp": "2024-01-15T10:35:00.000Z"
}
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –±–æ—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
- **–ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏** - –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–æ—Ç–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
- **–ë—ã—Å—Ç—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞** —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### üîÑ –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö  
- **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ –≤ –ë–î
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
- **Change Streams** –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: insert, update, delete

### üõ°Ô∏è –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π
- **–°—Ç–∞—Ç—É—Å—ã –±–æ—Ç–æ–≤** –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** –ø—Ä–∏ —Å–±–æ—è—Ö Change Stream
- **Graceful shutdown** —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–°–æ–±—ã—Ç–∏—è** –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞  
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–æ–≤
- **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –±–æ—Ç–æ–≤

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### –î–æ (—Å—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥)
```typescript
// –ö–∞–∂–¥—ã–π —Ä–∞–∑ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
const bot = new Telegraf(token);
await bot.telegram.sendMessage(chatId, message);
```

### –ü–æ—Å–ª–µ (—Å BotManager)
```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∏–∑ –∫–µ—à–∞
const result = await botManager.sendMessage(customerId, chatId, message);
```

## –ó–∞–ø—É—Å–∫ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫** –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ `src/index.ts`
2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è** –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB
3. **–°–ª—É—à–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π** –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
4. **Graceful shutdown** –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç:

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
```javascript
// –í MongoDB
db.customers.insertOne({
    username: "new_client",
    botToken: "7234567890:AAH...",
    password: "generated123"
});

// BotManager –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// 1. –ü–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Change Stream  
// 2. –°–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
// 3. –î–æ–±–∞–≤–∏—Ç –≤ –∫–µ—à
// 4. –í—ã–¥–∞—Å—Ç —Å–æ–±—ã—Ç–∏–µ 'bot:added'
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
```javascript
// –í MongoDB  
db.customers.updateOne(
    { username: "existing_client" },
    { $set: { botToken: "7234567890:NEW_TOKEN..." } }
);

// BotManager –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// 1. –ü–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏
// 2. –°–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
// 3. –ó–∞–º–µ–Ω–∏—Ç —Å—Ç–∞—Ä—ã–π –≤ –∫–µ—à–µ
// 4. –í—ã–¥–∞—Å—Ç —Å–æ–±—ã—Ç–∏–µ 'bot:updated'
```

### –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
```javascript
// –í MongoDB
db.customers.deleteOne({ username: "old_client" });

// BotManager –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// 1. –ü–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É–¥–∞–ª–µ–Ω–∏–∏
// 2. –£–¥–∞–ª–∏—Ç –±–æ—Ç–∞ –∏–∑ –∫–µ—à–∞  
// 3. –í—ã–¥–∞—Å—Ç —Å–æ–±—ã—Ç–∏–µ 'bot:removed'
```

## –õ–æ–≥–∏ –≤ –¥–µ–π—Å—Ç–≤–∏–∏

```bash
üîÑ Initializing BotManager...
‚úÖ Bot added for customer: client1 (@client1_bot)
‚úÖ Bot added for customer: client2 (@client2_bot) 
‚ùå Failed to add bot for customer client3: 401 Unauthorized
‚úÖ BotManager initialized with 2 bots
üëÅÔ∏è Started watching database changes

üì° Database change detected: update
üîÑ Bot updated for customer: client1 (@client1_new_bot)

üì° Database change detected: insert  
‚úÖ Bot added for customer: client4 (@client4_bot)
```

–≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞! üöÄ 